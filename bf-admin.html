<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BF Admin ‚Äî Panel de administraci√≥n</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Open+Sans:wght@300;400;600&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --orange:#ff6600;
            --bg:#111;
            --card:#1e1e1e;
            --card2:#252525;
            --border:#2e2e2e;
            --text:#d0d0d0;
            --muted:#888;
            --green:#22c55e;
            --red:#ef4444;
        }
        body{font-family:'Open Sans',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh}

        /* LOGIN */
        #login-screen{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center;}
        .login-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:3rem 2.5rem;width:100%;max-width:380px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.6);}
        .login-logo{font-family:'Oswald',sans-serif;font-size:1.6rem;color:var(--orange);text-transform:uppercase;letter-spacing:3px;margin-bottom:.3rem}
        .login-sub{color:var(--muted);font-size:.9rem;margin-bottom:2rem}
        .login-icon{font-size:3rem;margin-bottom:1.5rem;display:block}
        .login-input{width:100%;background:#151515;border:1px solid #333;border-radius:6px;color:#fff;font-size:1rem;padding:.85rem 1rem;outline:none;font-family:'Open Sans',sans-serif;transition:border-color .2s;text-align:center;letter-spacing:4px;}
        .login-input:focus{border-color:var(--orange)}
        .login-btn{width:100%;margin-top:1rem;background:var(--orange);color:#fff;border:none;border-radius:6px;padding:.9rem;font-family:'Oswald',sans-serif;font-size:1.1rem;text-transform:uppercase;letter-spacing:2px;cursor:pointer;transition:all .2s;}
        .login-btn:hover{background:#e55a00}
        .login-error{color:var(--red);font-size:.85rem;margin-top:.8rem;display:none}

        /* ADMIN LAYOUT */
        #admin-panel{display:none}
        .admin-header{background:linear-gradient(to right,#080808,#161616);border-bottom:3px solid var(--orange);padding:1.2rem 0;position:sticky;top:0;z-index:100;box-shadow:0 4px 24px rgba(255,102,0,.2);}
        .admin-header-inner{max-width:1100px;margin:0 auto;padding:0 2rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem}
        .admin-title{font-family:'Oswald',sans-serif;color:var(--orange);font-size:1.4rem;text-transform:uppercase;letter-spacing:2px}
        .admin-title span{color:#fff;font-size:.85rem;display:block;letter-spacing:1px;font-weight:400;margin-top:1px}
        .header-actions{display:flex;gap:.8rem;align-items:center;flex-wrap:wrap}
        .btn{padding:.5rem 1.2rem;border-radius:4px;cursor:pointer;font-family:'Oswald',sans-serif;font-size:.9rem;text-transform:uppercase;letter-spacing:1px;transition:all .2s;border:none;text-decoration:none;display:inline-flex;align-items:center;gap:.4rem}
        .btn-orange{background:var(--orange);color:#fff}
        .btn-orange:hover{background:#e55a00}
        .btn-ghost{background:none;border:1px solid #444;color:var(--muted)}
        .btn-ghost:hover{border-color:var(--orange);color:var(--orange)}
        .btn-red{background:none;border:1px solid #553;color:#a88}
        .btn-red:hover{border-color:var(--red);color:var(--red)}

        /* TABS */
        .admin-tabs{max-width:1100px;margin:2rem auto 0;padding:0 2rem;display:flex;gap:0;border-bottom:2px solid var(--border)}
        .admin-tab{padding:.8rem 1.8rem;cursor:pointer;font-family:'Oswald',sans-serif;font-size:1rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);border-bottom:3px solid transparent;margin-bottom:-2px;transition:all .2s;background:none;border-left:none;border-right:none;border-top:none}
        .admin-tab:hover{color:#ddd}
        .admin-tab.active{color:var(--orange);border-bottom-color:var(--orange)}

        /* CONTENT */
        .admin-content{max-width:1100px;margin:0 auto;padding:2rem}
        .tab-panel{display:none}
        .tab-panel.active{display:block}

        /* CARDS */
        .panel-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:1.8rem;margin-bottom:1.5rem}
        .panel-card h3{font-family:'Oswald',sans-serif;color:var(--orange);font-size:1.1rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:1.2rem;display:flex;align-items:center;gap:.5rem}

        /* FORMS */
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem}
        .form-row.full{grid-template-columns:1fr}
        .form-group{display:flex;flex-direction:column;gap:.4rem}
        label{font-size:.85rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
        input[type=text],input[type=date],textarea,select,input[type=password]{background:#151515;border:1px solid #333;border-radius:5px;color:#fff;font-size:.95rem;padding:.7rem .9rem;outline:none;font-family:'Open Sans',sans-serif;transition:border-color .2s;width:100%;}
        input:focus,textarea:focus,select:focus{border-color:var(--orange)}
        textarea{resize:vertical;min-height:120px}
        .char-count{font-size:.75rem;color:var(--muted);text-align:right;margin-top:.2rem}

        /* UPLOAD AREA */
        .upload-area{border:2px dashed #333;border-radius:6px;padding:2rem;text-align:center;cursor:pointer;transition:all .2s;position:relative;}
        .upload-area:hover{border-color:var(--orange);background:rgba(255,102,0,.04)}
        .upload-area input{display:none}
        .upload-area-text{color:var(--muted);font-size:.9rem}
        .upload-area-text span{display:block;font-size:2rem;margin-bottom:.5rem}
        .upload-progress{display:none;margin-top:1rem;}
        .progress-bar{height:6px;background:#333;border-radius:3px;overflow:hidden;margin-top:.5rem;}
        .progress-fill{height:100%;background:var(--orange);width:0%;transition:width .3s;border-radius:3px;}
        .img-preview-wrap{margin-top:1rem;display:none;}
        .img-preview-wrap img{max-height:180px;border-radius:6px;margin:0 auto;}
        .img-preview-wrap .remove-img{font-size:.75rem;color:var(--red);cursor:pointer;margin-top:.4rem;display:block;text-align:center;}

        /* NOVEDAD LIST */
        .novedad-row{display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--card2);border:1px solid var(--border);border-radius:6px;margin-bottom:.7rem;transition:border-color .2s;}
        .novedad-row:hover{border-color:#444}
        .novedad-thumb{width:72px;height:48px;border-radius:4px;flex-shrink:0;background:#222;display:flex;align-items:center;justify-content:center;font-size:1.4rem;color:#444;overflow:hidden;}
        .novedad-thumb img{width:100%;height:100%;object-fit:cover;}
        .novedad-row-info{flex:1;min-width:0}
        .novedad-row-title{font-weight:600;color:#ddd;font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .novedad-row-date{font-size:.78rem;color:var(--orange)}
        .btn-sm{padding:.3rem .7rem;font-size:.78rem;border-radius:3px;cursor:pointer;border:1px solid #444;background:none;color:var(--muted);transition:all .2s;font-family:'Open Sans',sans-serif}
        .btn-sm:hover{border-color:var(--orange);color:var(--orange)}
        .btn-sm.del:hover{border-color:var(--red);color:var(--red)}

        /* GALLERY */
        .cat-select-row{display:flex;gap:.8rem;margin-bottom:1.5rem;flex-wrap:wrap}
        .cat-pill{padding:.5rem 1.2rem;border-radius:20px;border:1px solid var(--border);background:none;color:var(--muted);cursor:pointer;font-family:'Oswald',sans-serif;font-size:.9rem;text-transform:uppercase;letter-spacing:1px;transition:all .2s}
        .cat-pill:hover,.cat-pill.active{background:var(--orange);color:#fff;border-color:var(--orange)}
        .photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem}
        .photo-admin-card{background:var(--card2);border:1px solid var(--border);border-radius:6px;overflow:hidden;transition:all .2s;}
        .photo-admin-card:hover{border-color:#555}
        .photo-admin-card img{width:100%;aspect-ratio:4/3;object-fit:cover;display:block}
        .photo-admin-caption{padding:.6rem .8rem;display:flex;align-items:center;justify-content:space-between;gap:.4rem}
        .photo-admin-name{font-size:.83rem;color:#ccc;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .rename-inline{background:#1a1a1a;border:1px solid var(--orange);border-radius:3px;color:#fff;font-size:.83rem;padding:.18rem .4rem;width:100%;outline:none}
        .add-photo-tile{border:2px dashed #333;border-radius:6px;aspect-ratio:4/3;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;}
        .add-photo-tile:hover{border-color:var(--orange);background:rgba(255,102,0,.04)}
        .add-photo-tile input{display:none}
        .add-photo-tile span{font-size:2rem;color:#444}
        .add-photo-tile p{font-size:.75rem;color:#555;margin-top:.3rem;text-transform:uppercase;letter-spacing:1px}
        .uploading-indicator{position:absolute;inset:0;background:rgba(0,0,0,.7);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.5rem;border-radius:6px;}
        .uploading-indicator p{font-size:.8rem;color:#ccc}
        .spinner-sm{width:28px;height:28px;border:3px solid #333;border-top-color:var(--orange);border-radius:50%;animation:spin .7s linear infinite;}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* INFO BOX */
        .info-box{background:rgba(255,102,0,.07);border:1px solid rgba(255,102,0,.2);border-radius:6px;padding:1rem 1.2rem;font-size:.88rem;color:var(--muted);margin-bottom:1.5rem;display:flex;gap:.8rem;align-items:flex-start;}
        .info-box span{font-size:1.2rem;flex-shrink:0;}

        /* TOAST */
        .toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(20px);background:#222;color:#ddd;border-left:3px solid var(--orange);padding:.8rem 1.6rem;border-radius:6px;font-size:.9rem;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;z-index:9000}
        .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

        /* PW */
        .pw-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
        @media(max-width:600px){.form-row{grid-template-columns:1fr}.pw-grid{grid-template-columns:1fr}.admin-tabs{overflow-x:auto}.admin-tab{white-space:nowrap;font-size:.85rem;padding:.7rem 1.2rem}}
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
    <div class="login-box">
        <span class="login-icon">üîê</span>
        <div class="login-logo">BF Admin</div>
        <div class="login-sub">Panel de administraci√≥n ‚Äî solo uso interno</div>
        <input type="password" class="login-input" id="pw-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="30"
               onkeydown="if(event.key==='Enter')tryLogin()">
        <button class="login-btn" onclick="tryLogin()">Ingresar</button>
        <div class="login-error" id="login-error">Contrase√±a incorrecta</div>
    </div>
</div>

<!-- ADMIN PANEL -->
<div id="admin-panel">

    <div class="admin-header">
        <div class="admin-header-inner">
            <div class="admin-title">‚öô BF Admin <span>Panel de administraci√≥n</span></div>
            <div class="header-actions">
                <a href="index.html" target="_blank" class="btn btn-ghost">üåê Ver sitio</a>
                <button class="btn btn-red" onclick="logout()">üö™ Salir</button>
            </div>
        </div>
    </div>

    <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchTab('novedades',this)">üì∞ Novedades</button>
        <button class="admin-tab" onclick="switchTab('galeria',this)">üñºÔ∏è Galer√≠a</button>
        <button class="admin-tab" onclick="switchTab('config',this)">‚öôÔ∏è Configuraci√≥n</button>
    </div>

    <div class="admin-content">

        <!-- TAB NOVEDADES -->
        <div class="tab-panel active" id="tab-novedades">
            <div class="panel-card">
                <h3>‚ûï Nueva novedad</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>T√≠tulo *</label>
                        <input type="text" id="n-title" placeholder="Ej: Nuevo trailer entregado" maxlength="100" oninput="updateChar(this,'n-title-count')">
                        <div class="char-count"><span id="n-title-count">0</span>/100</div>
                    </div>
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" id="n-date">
                    </div>
                </div>
                <div class="form-row full">
                    <div class="form-group">
                        <label>Texto / descripci√≥n *</label>
                        <textarea id="n-text" placeholder="Cont√° los detalles del trabajo, novedad o proyecto..." maxlength="2000" oninput="updateChar(this,'n-text-count')"></textarea>
                        <div class="char-count"><span id="n-text-count">0</span>/2000</div>
                    </div>
                </div>
                <div class="form-row full">
                    <div class="form-group">
                        <label>Imagen (opcional)</label>
                        <label class="upload-area" id="n-upload-area">
                            <input type="file" accept="image/*" id="n-img-input" onchange="handleNovedadImg(this)">
                            <div class="upload-area-text" id="n-upload-text">
                                <span>üì∑</span>
                                Hac√© clic para seleccionar una imagen
                            </div>
                            <div class="img-preview-wrap" id="n-preview-wrap">
                                <img id="n-img-preview" src="" alt="">
                                <span class="remove-img" onclick="removeNovedadImg(event)">‚úï Quitar imagen</span>
                            </div>
                        </label>
                    </div>
                </div>
                <button class="btn btn-orange" onclick="saveNovedad()" style="margin-top:.5rem" id="n-save-btn">‚úÖ Publicar novedad</button>
            </div>

            <div class="panel-card">
                <h3>üìã Novedades publicadas</h3>
                <div id="novedades-list"><p style="color:var(--muted);font-size:.9rem">Cargando...</p></div>
            </div>
        </div>

        <!-- TAB GALER√çA -->
        <div class="tab-panel" id="tab-galeria">
            <div class="panel-card">
                <h3>üñºÔ∏è Gesti√≥n de fotos</h3>
                <div class="info-box">
                    <span>‚òÅÔ∏è</span>
                    <span>Las fotos se suben a <strong>Cloudinary</strong> y quedan guardadas en la nube permanentemente. Son visibles para todos los visitantes del sitio.</span>
                </div>
                <div class="cat-select-row">
                    <button class="cat-pill active" onclick="selectCat('carrocerias',this)">üöõ Carrocer√≠as</button>
                    <button class="cat-pill" onclick="selectCat('estructuras',this)">üèóÔ∏è Estructuras</button>
                    <button class="cat-pill" onclick="selectCat('equipamiento',this)">‚ö° Equipamiento</button>
                    <button class="cat-pill" onclick="selectCat('otros',this)">üî© Otros</button>
                </div>
                <div class="photo-grid" id="admin-photo-grid"></div>
            </div>
        </div>

        <!-- TAB CONFIG -->
        <div class="tab-panel" id="tab-config">
            <div class="panel-card">
                <h3>üîë Token de GitHub</h3>
                <div class="info-box">
                    <span>‚ÑπÔ∏è</span>
                    <span>El token permite guardar las novedades en GitHub. Se guarda solo en este navegador. Ten√©s que pegarlo una vez por dispositivo.</span>
                </div>
                <div class="form-row full">
                    <div class="form-group">
                        <label>Personal Access Token (ghp_...)</label>
                        <input type="password" id="gh-token-input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                    </div>
                </div>
                <button class="btn btn-orange" onclick="saveGhToken()">üíæ Guardar token</button>
                <span id="gh-token-status" style="margin-left:1rem;font-size:.85rem;color:var(--muted)"></span>
            </div>
            <div class="panel-card">
                <h3>üîí Cambiar contrase√±a</h3>
                <div class="pw-grid">
                    <div class="form-group">
                        <label>Nueva contrase√±a</label>
                        <input type="password" id="new-pw1" placeholder="M√≠nimo 6 caracteres">
                    </div>
                    <div class="form-group">
                        <label>Repetir contrase√±a</label>
                        <input type="password" id="new-pw2" placeholder="Repet√≠ la contrase√±a">
                    </div>
                </div>
                <button class="btn btn-orange" onclick="changePassword()" style="margin-top:1rem">Guardar contrase√±a</button>
            </div>
            <div class="panel-card">
                <h3>üåê Links r√°pidos</h3>
                <div style="display:flex;gap:1rem;flex-wrap:wrap">
                    <a href="index.html" target="_blank" class="btn btn-ghost">Ver Inicio</a>
                    <a href="bf-productos.html" target="_blank" class="btn btn-ghost">Ver Galer√≠a</a>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CLOUDINARY CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CLOUD_NAME   = 'dtmgoqeuq';
const UPLOAD_PRESET = 'ml_default';
const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/' + CLOUD_NAME + '/image/upload';

async function uploadToCloudinary(file, folder) {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', UPLOAD_PRESET);
    fd.append('folder', 'bf/' + folder);
    const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: fd });
    if (!res.ok) throw new Error('Error subiendo imagen');
    const data = await res.json();
    return data.secure_url; // URL permanente de la imagen
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PASSWORD  (localStorage ‚Äî funciona en GitHub Pages)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Hash SHA-256 de 'bf2026' ‚Äî cambialo desde Configuraci√≥n
const DEFAULT_HASH = '74a288a738c373adefa0095c5e7aafc794c741aebdb66871e6afd10321c95ca3';

async function hashPw(pw) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pw));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function tryLogin() {
    const pw = document.getElementById('pw-input').value;
    if (!pw) return;
    const storedHash = localStorage.getItem('bf-admin-pwhash') || DEFAULT_HASH;
    const inputHash  = await hashPw(pw);
    if (inputHash === storedHash) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('admin-panel').style.display = 'block';
        await initAdmin();
    } else {
        const err = document.getElementById('login-error');
        err.style.display = 'block';
        document.getElementById('pw-input').value = '';
        setTimeout(() => err.style.display = 'none', 3000);
    }
}

async function changePassword() {
    const p1 = document.getElementById('new-pw1').value;
    const p2 = document.getElementById('new-pw2').value;
    if (!p1 || p1.length < 6) { showToast('‚ö†Ô∏è M√≠nimo 6 caracteres'); return; }
    if (p1 !== p2) { showToast('‚ö†Ô∏è Las contrase√±as no coinciden'); return; }
    localStorage.setItem('bf-admin-pwhash', await hashPw(p1));
    document.getElementById('new-pw1').value = '';
    document.getElementById('new-pw2').value = '';
    showToast('‚úÖ Contrase√±a actualizada');
}

function logout() {
    document.getElementById('admin-panel').style.display = 'none';
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('pw-input').value = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GITHUB API ‚Äî Novedades
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GH_USER   = 'francobocchi22-spec';
const GH_REPO   = 'BFPRODYSERV';
const GH_FILE   = 'novedades.json';
const GH_API    = 'https://api.github.com/repos/' + GH_USER + '/' + GH_REPO + '/contents/' + GH_FILE;
let GH_TOKEN    = localStorage.getItem('bf-gh-token') || '';
let GH_FILE_SHA = '';

async function ghLoad() {
    if (!GH_TOKEN) return [];
    try {
        const res = await fetch(GH_API, {
            headers: { 'Authorization': 'token ' + GH_TOKEN, 'Accept': 'application/vnd.github.v3+json' }
        });
        if (res.status === 404) return []; // archivo no existe todav√≠a
        if (!res.ok) return [];
        const data = await res.json();
        GH_FILE_SHA = data.sha;
        return JSON.parse(atob(data.content.replace(/\n/g, '')));
    } catch(e) { return []; }
}

async function ghSave(list) {
    if (!GH_TOKEN) { showToast('‚ö†Ô∏è Configur√° el Token de GitHub en Configuraci√≥n'); return false; }
    try {
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(list, null, 2))));
        const body = { message: 'Actualizar novedades', content };
        if (GH_FILE_SHA) body.sha = GH_FILE_SHA;
        const res = await fetch(GH_API, {
            method: 'PUT',
            headers: { 'Authorization': 'token ' + GH_TOKEN, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        if (!res.ok) { showToast('‚ö†Ô∏è Error al guardar. Verific√° el token.'); return false; }
        const data = await res.json();
        GH_FILE_SHA = data.content.sha;
        return true;
    } catch(e) { showToast('‚ö†Ô∏è Error de conexi√≥n'); return false; }
}

function switchTab(name, btn) {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.admin-tab').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    btn.classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NOVEDADES STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let novedades = [];
let nImgFile = null;
let nImgPreviewUrl = null;

async function loadNovedades() {
    try { novedades = await ghLoad(); } catch(e) { novedades = []; }
}

async function saveNovedadesIndex() {
    return await ghSave(novedades);
}

function handleNovedadImg(input) {
    const file = input.files[0];
    if (!file) return;
    nImgFile = file;
    const reader = new FileReader();
    reader.onload = e => {
        nImgPreviewUrl = e.target.result;
        document.getElementById('n-upload-text').style.display = 'none';
        const wrap = document.getElementById('n-preview-wrap');
        document.getElementById('n-img-preview').src = nImgPreviewUrl;
        wrap.style.display = 'block';
    };
    reader.readAsDataURL(file);
}

function removeNovedadImg(e) {
    e.preventDefault();
    nImgFile = null; nImgPreviewUrl = null;
    document.getElementById('n-img-input').value = '';
    document.getElementById('n-preview-wrap').style.display = 'none';
    document.getElementById('n-upload-text').style.display = '';
}

async function saveNovedad() {
    const title = document.getElementById('n-title').value.trim();
    const date  = document.getElementById('n-date').value;
    const text  = document.getElementById('n-text').value.trim();
    if (!title) { showToast('‚ö†Ô∏è El t√≠tulo es obligatorio'); return; }
    if (!date)  { showToast('‚ö†Ô∏è La fecha es obligatoria'); return; }
    if (!text)  { showToast('‚ö†Ô∏è El texto es obligatorio'); return; }

    const btn = document.getElementById('n-save-btn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Publicando...';

    let imgUrl = null;
    if (nImgFile) {
        try {
            showToast('‚òÅÔ∏è Subiendo imagen...');
            imgUrl = await uploadToCloudinary(nImgFile, 'novedades');
        } catch(e) {
            showToast('‚ö†Ô∏è Error al subir imagen. Verific√° tu conexi√≥n.');
            btn.disabled = false;
            btn.textContent = '‚úÖ Publicar novedad';
            return;
        }
    }

    const id = 'n' + Date.now();
    novedades.push({ id, title, date, text, img: imgUrl });
    await saveNovedadesIndex();

    // Reset form
    document.getElementById('n-title').value = '';
    document.getElementById('n-date').value = new Date().toISOString().slice(0,10);
    document.getElementById('n-text').value = '';
    removeNovedadImg({ preventDefault:()=>{} });
    updateChar(document.getElementById('n-title'), 'n-title-count');
    updateChar(document.getElementById('n-text'), 'n-text-count');
    nImgFile = null;

    btn.disabled = false;
    btn.textContent = '‚úÖ Publicar novedad';
    renderNovedasList();
    showToast('‚úÖ Novedad publicada correctamente');
}

function renderNovedasList() {
    const el = document.getElementById('novedades-list');
    if (!novedades.length) { el.innerHTML = '<p style="color:var(--muted);font-size:.9rem">No hay novedades publicadas todav√≠a.</p>'; return; }
    el.innerHTML = '';
    [...novedades].sort((a,b) => b.date.localeCompare(a.date)).forEach(n => {
        const row = document.createElement('div');
        row.className = 'novedad-row';
        row.innerHTML =
            '<div class="novedad-thumb">' + (n.img ? '<img src="'+n.img+'">' : 'üì∞') + '</div>' +
            '<div class="novedad-row-info">' +
                '<div class="novedad-row-title">'+escHtml(n.title)+'</div>' +
                '<div class="novedad-row-date">'+formatDate(n.date)+'</div>' +
            '</div>' +
            '<div style="display:flex;gap:.5rem;flex-shrink:0">' +
                '<button class="btn-sm del" onclick="deleteNovedad(\''+n.id+'\')">üóëÔ∏è Borrar</button>' +
            '</div>';
        el.appendChild(row);
    });
}

async function deleteNovedad(id) {
    if (!confirm('¬øEliminar esta novedad?')) return;
    novedades = novedades.filter(n => n.id !== id);
    await saveNovedadesIndex();
    renderNovedasList();
    showToast('üóëÔ∏è Novedad eliminada');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GALER√çA ‚Äî Cloudinary
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CATS = ['carrocerias','estructuras','equipamiento','otros'];
let photos = { carrocerias:[], estructuras:[], equipamiento:[], otros:[] };
let activeCat = 'carrocerias';

async function loadPhotos() {
    for (const cat of CATS) {
        try {
            const r = localStorage.getItem('bf-cl-index-' + cat);
            photos[cat] = r ? JSON.parse(r) : [];
        } catch(e) { photos[cat] = []; }
    }
}

async function savePhotoIndex(cat) {
    localStorage.setItem('bf-cl-index-' + cat, JSON.stringify(photos[cat]));
}

function selectCat(cat, btn) {
    activeCat = cat;
    document.querySelectorAll('.cat-pill').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    renderPhotoGrid();
}

function renderPhotoGrid() {
    const grid = document.getElementById('admin-photo-grid');
    grid.innerHTML = '';

    for (const p of photos[activeCat]) {
        const card = document.createElement('div');
        card.className = 'photo-admin-card';
        card.dataset.id = p.id;
        card.style.position = 'relative';
        card.innerHTML =
            '<img src="'+p.url+'" alt="'+escHtml(p.name)+'">' +
            '<div class="photo-admin-caption">' +
                '<span class="photo-admin-name" id="aname-'+p.id+'">'+escHtml(p.name)+'</span>' +
                '<div style="display:flex;gap:.3rem;flex-shrink:0">' +
                    '<button class="btn-sm" onclick="startRename(\''+p.id+'\')">‚úèÔ∏è</button>' +
                    '<button class="btn-sm del" onclick="deletePhoto(\''+p.id+'\',\''+activeCat+'\')">üóëÔ∏è</button>' +
                '</div>' +
            '</div>';
        grid.appendChild(card);
    }

    // Add tile
    const addTile = document.createElement('label');
    addTile.className = 'add-photo-tile';
    addTile.style.position = 'relative';
    addTile.innerHTML =
        '<input type="file" accept="image/*" multiple onchange="addPhotos(this,\''+activeCat+'\')">' +
        '<span>Ôºã</span><p>Agregar foto</p>';
    grid.appendChild(addTile);
}

async function addPhotos(input, cat) {
    const files = Array.from(input.files);
    if (!files.length) return;
    input.value = '';

    // Show uploading state on the tile
    const tile = input.parentElement;
    tile.innerHTML = '<div class="uploading-indicator"><div class="spinner-sm"></div><p>Subiendo '+files.length+' foto(s)...</p></div>';

    let uploaded = 0;
    for (const file of files) {
        try {
            const url = await uploadToCloudinary(file, cat);
            const id = 'p' + Date.now() + Math.random().toString(36).slice(2,5);
            const name = file.name.replace(/\.[^.]+$/, '');
            photos[cat].push({ id, name, url });
            await savePhotoIndex(cat);
            uploaded++;
            showToast('‚òÅÔ∏è ' + uploaded + '/' + files.length + ' foto(s) subida(s)...');
        } catch(e) {
            showToast('‚ö†Ô∏è Error subiendo "' + file.name + '"');
        }
    }

    renderPhotoGrid();
    showToast('‚úÖ ' + uploaded + ' foto(s) guardada(s) en Cloudinary');
}

function startRename(id) {
    const el = document.getElementById('aname-' + id);
    const prev = el.textContent;
    const inp = document.createElement('input');
    inp.className = 'rename-inline';
    inp.value = prev;
    const finish = async () => {
        const val = inp.value.trim() || prev;
        const p = photos[activeCat].find(x => x.id === id);
        if (p) { p.name = val; await savePhotoIndex(activeCat); }
        renderPhotoGrid();
        showToast('‚úÖ Renombrada a "' + val + '"');
    };
    inp.onkeydown = e => { if(e.key==='Enter') finish(); if(e.key==='Escape') renderPhotoGrid(); };
    inp.onblur = finish;
    el.replaceWith(inp);
    inp.focus(); inp.select();
}

async function deletePhoto(id, cat) {
    if (!confirm('¬øEliminar esta foto de la galer√≠a?')) return;
    photos[cat] = photos[cat].filter(p => p.id !== id);
    await savePhotoIndex(cat);
    renderPhotoGrid();
    showToast('üóëÔ∏è Foto eliminada de la galer√≠a');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateChar(el, countId) { document.getElementById(countId).textContent = el.value.length; }
function escHtml(s) { return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function formatDate(iso) { return new Date(iso).toLocaleDateString('es-AR',{day:'2-digit',month:'long',year:'numeric'}); }
let _tt;
function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    clearTimeout(_tt); _tt = setTimeout(()=>t.classList.remove('show'), 3500);
}

function saveGhToken() {
    const val = document.getElementById('gh-token-input').value.trim();
    if (!val) { showToast('‚ö†Ô∏è Peg√° el token primero'); return; }
    GH_TOKEN = val;
    localStorage.setItem('bf-gh-token', val);
    document.getElementById('gh-token-status').textContent = '‚úÖ Token guardado';
    showToast('‚úÖ Token guardado correctamente');
}

async function initAdmin() {
    const savedToken = localStorage.getItem('bf-gh-token');
    if (savedToken) {
        GH_TOKEN = savedToken;
        const inp = document.getElementById('gh-token-input');
        if (inp) inp.value = savedToken;
        document.getElementById('gh-token-status').textContent = '‚úÖ Token configurado';
    }
    await Promise.all([loadNovedades(), loadPhotos()]);
    renderNovedasList();
    renderPhotoGrid();
    document.getElementById('n-date').value = new Date().toISOString().slice(0,10);
}
</script>
</body>
</html>
